<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JobPipeline</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#0a0a0f;color:#f0f0f5;min-height:100vh;padding:24px 16px;}
.wrap{max-width:1000px;margin:0 auto;}

/* Nav */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;gap:12px;flex-wrap:wrap;}
.logo{display:flex;align-items:center;gap:10px;font-family:Georgia,serif;font-size:clamp(22px,4vw,38px);font-weight:900;background:linear-gradient(135deg,#ff4d6d,#ffd166);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav{display:flex;gap:8px;}
.nbtn{background:#12121a;border:1px solid #2a2a3a;border-radius:10px;color:#6b6b80;cursor:pointer;font-size:13px;font-weight:600;padding:10px 18px;font-family:inherit;position:relative;}
.nbtn.on{background:rgba(255,209,102,0.1);border-color:#ffd166;color:#ffd166;}
.badge{position:absolute;top:-7px;right:-7px;background:#ff4d6d;color:#fff;font-size:10px;font-weight:700;border-radius:20px;padding:2px 6px;display:none;}

/* Card */
.card{background:#12121a;border:1px solid #2a2a3a;border-radius:14px;padding:24px;margin-bottom:14px;}
.card-stripe{height:2px;background:linear-gradient(90deg,#ff4d6d,#ffd166);border-radius:14px 14px 0 0;margin:-24px -24px 20px;}
.lbl{display:block;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:#6b6b80;margin-bottom:8px;font-weight:600;}

/* Inputs */
.inp{width:100%;background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;color:#f0f0f5;font-size:15px;padding:12px 15px;outline:none;font-family:inherit;}
.inp:focus{border-color:#ff4d6d;}
.row2{display:grid;grid-template-columns:1fr 120px;gap:12px;margin-bottom:14px;}
@media(max-width:500px){.row2{grid-template-columns:1fr;}}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;}
.chip{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:100px;color:#6b6b80;cursor:pointer;font-size:13px;font-weight:600;padding:7px 16px;font-family:inherit;}
.chip.on{background:rgba(255,77,109,0.15);border-color:#ff4d6d;color:#ff4d6d;}
.ftrow{display:flex;gap:8px;margin-bottom:12px;}
.ftrow .inp{margin:0;}
.ftadd{background:#1a1a26;border:1px solid #2a2a3a;border-radius:10px;color:#6b6b80;cursor:pointer;font-size:13px;font-weight:700;padding:12px 16px;font-family:inherit;white-space:nowrap;flex-shrink:0;}
.seltags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
.stag{background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);border-radius:100px;color:#ff4d6d;font-size:12px;font-weight:600;padding:4px 12px;display:inline-flex;align-items:center;gap:6px;}
.stag-x{background:none;border:none;color:#ff4d6d;cursor:pointer;font-size:14px;padding:0;line-height:1;}
.hint{font-size:11px;color:#6b6b80;margin-bottom:12px;}

/* Radio rows */
.rrow{display:flex;gap:8px;margin-bottom:14px;}
.rbtn{flex:1;background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;color:#6b6b80;cursor:pointer;font-size:13px;font-weight:700;padding:10px 4px;font-family:inherit;text-align:center;}
.rbtn.on{background:rgba(255,77,109,0.15);border-color:#ff4d6d;color:#ff4d6d;}

/* Search button */
.gobtn{width:100%;background:linear-gradient(135deg,#ff4d6d,#c9184a);border:none;border-radius:10px;color:#fff;cursor:pointer;font-size:16px;font-weight:700;padding:14px;font-family:inherit;}
.gobtn:disabled{opacity:.5;}

/* Status */
.spinner{width:36px;height:36px;border:2px solid #2a2a3a;border-top-color:#ff4d6d;border-radius:50%;margin:40px auto 10px;animation:spin .8s linear infinite;}
.stxt{text-align:center;color:#6b6b80;padding-bottom:28px;font-size:14px;}
.errbx{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);border-radius:10px;color:#ff4d6d;padding:13px 16px;margin-bottom:12px;font-size:14px;}
.infobx{background:rgba(255,209,102,.06);border:1px solid rgba(255,209,102,.2);border-radius:10px;color:#ffd166;padding:11px 15px;margin-bottom:14px;font-size:13px;}

/* Result header */
.reshdr{font-size:18px;font-weight:800;margin-bottom:8px;}
.reshdr .rc{color:#ff4d6d;}
.reshdr .rt{color:#6b6b80;font-size:13px;font-weight:400;}
.restags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;}
.rtag{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.18);border-radius:100px;color:#6b6b80;font-size:11px;font-weight:600;padding:3px 10px;}

/* Job card */
.jcard{background:#12121a;border:1px solid #2a2a3a;border-radius:12px;margin-bottom:10px;padding:18px 20px;}
.jcard-top{display:flex;gap:12px;justify-content:space-between;margin-bottom:10px;}
.jtitle{font-size:16px;font-weight:700;margin-bottom:2px;}
.jco{color:#ffd166;font-size:13px;font-weight:500;margin-bottom:6px;}
.jmeta{display:flex;gap:12px;flex-wrap:wrap;}
.jmi{color:#6b6b80;font-size:12px;}
.jright{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;}
.jbadge{background:#1a1a26;border:1px solid #2a2a3a;border-radius:6px;color:#6b6b80;font-size:10px;font-weight:700;letter-spacing:1px;padding:3px 8px;text-transform:uppercase;}
.jas{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.18);border-radius:6px;color:#ff4d6d;font-size:10px;font-weight:600;padding:3px 8px;}
.jsal{background:rgba(255,209,102,.1);border:1px solid rgba(255,209,102,.25);border-radius:6px;color:#ffd166;font-size:11px;font-weight:700;padding:3px 8px;}
.jdesc{color:#6b6b80;font-size:13px;line-height:1.6;border-top:1px solid #2a2a3a;padding-top:10px;margin-top:6px;}
.jlink{color:#ff4d6d;text-decoration:none;font-size:12px;margin-left:6px;}
.jactions{display:flex;gap:8px;border-top:1px solid #2a2a3a;padding-top:10px;margin-top:8px;align-items:center;flex-wrap:wrap;}
.savebtn{background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);border-radius:8px;color:#22c55e;cursor:pointer;font-size:12px;font-weight:700;padding:7px 14px;font-family:inherit;}
.skipbtn{background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.2);border-radius:8px;color:#6b6b80;cursor:pointer;font-size:12px;font-weight:700;padding:7px 14px;font-family:inherit;}
.jnote{color:#6b6b80;font-size:11px;margin-left:auto;}
.nores{text-align:center;color:#6b6b80;padding:40px 0;}

/* Platform */
.platsec{background:#12121a;border:1px solid #2a2a3a;border-radius:12px;padding:18px 20px;margin-bottom:10px;}
.plathdr{font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;}
.platgrd{display:grid;grid-template-columns:repeat(auto-fill,minmax(138px,1fr));gap:7px;}
.plink{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;color:#f0f0f5;display:flex;flex-direction:column;align-items:center;gap:2px;font-size:12px;font-weight:600;padding:10px 7px;text-align:center;text-decoration:none;}
.plink .pi{font-size:18px;margin-bottom:1px;}
.plink .ps{font-size:10px;color:#6b6b80;font-weight:400;}
.plink .paw{font-size:9px;background:rgba(255,209,102,.12);border:1px solid rgba(255,209,102,.25);color:#ffd166;border-radius:3px;padding:1px 5px;font-weight:700;}
.it-hdr{color:#00c8ff;} .ex-hdr{color:#c084fc;} .gn-hdr{color:#ffd166;}

/* Merkzettel */
.saved-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
.savtitle{font-size:20px;font-weight:800;}
.savtitle span{color:#ffd166;}
.sfrow{display:flex;gap:7px;flex-wrap:wrap;}
.sfbtn{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:100px;color:#6b6b80;cursor:pointer;font-size:12px;font-weight:600;padding:6px 14px;font-family:inherit;}
.sfbtn.on{border-color:#ffd166;color:#ffd166;background:rgba(255,209,102,0.07);}
.clrbtn{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:8px;color:#6b6b80;cursor:pointer;font-size:12px;font-weight:600;padding:7px 13px;font-family:inherit;}
.scard{background:#12121a;border:1px solid #2a2a3a;border-radius:13px;padding:18px 20px;margin-bottom:12px;}
.scard-top{display:flex;gap:12px;justify-content:space-between;margin-bottom:10px;}
.scard-info{flex:1;min-width:0;}
.sc-title a{color:#f0f0f5;text-decoration:none;font-size:15px;font-weight:700;}
.sc-title a:hover{color:#ff4d6d;}
.sc-co{color:#ffd166;font-size:13px;margin-bottom:5px;}
.sc-meta{display:flex;gap:12px;flex-wrap:wrap;}
.sc-date{font-size:11px;color:#6b6b80;}
.scard-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0;}
.ssel{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:100px;color:#f0f0f5;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;font-family:inherit;outline:none;}
.snote{width:100%;background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;color:#f0f0f5;font-size:13px;padding:10px 13px;font-family:inherit;resize:none;min-height:68px;outline:none;}
.snote:focus{border-color:#ffd166;}
.sactions{display:flex;gap:8px;margin-top:8px;align-items:center;}
.nsavebtn{background:rgba(255,209,102,0.1);border:1px solid rgba(255,209,102,0.25);border-radius:8px;color:#ffd166;cursor:pointer;font-size:12px;font-weight:700;padding:7px 14px;font-family:inherit;}
.nhint{font-size:11px;color:#22c55e;display:none;margin-left:4px;}
.delbtn{background:rgba(255,77,109,0.07);border:1px solid rgba(255,77,109,0.18);border-radius:8px;color:#6b6b80;cursor:pointer;font-size:12px;font-weight:600;padding:7px 14px;font-family:inherit;margin-left:auto;}
.savempty{text-align:center;color:#6b6b80;padding:60px 0;font-size:15px;}
.footer{text-align:center;color:#2a2a3a;font-size:11px;margin-top:12px;padding-bottom:20px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Jira */
.cfgbtn{background:#12121a;border:1px solid #2a2a3a;border-radius:10px;color:#6b6b80;cursor:pointer;font-size:13px;font-weight:600;padding:10px 14px;font-family:inherit;transition:border-color .2s,color .2s;}
.cfgbtn:hover{border-color:#2684ff;color:#2684ff;}
.cfgbtn.active{background:rgba(38,132,255,0.1);border-color:#2684ff;color:#2684ff;}
.jirabtn{background:rgba(38,132,255,0.1);border:1px solid rgba(38,132,255,0.25);border-radius:8px;color:#2684ff;cursor:pointer;font-size:12px;font-weight:700;padding:7px 14px;font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;transition:opacity .2s;}
.jirabtn:disabled{opacity:.5;cursor:default;}
.jirabtn.ok{background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.25);color:#22c55e;}
.jirabtn.err{background:rgba(255,77,109,0.1);border-color:rgba(255,77,109,0.25);color:#ff4d6d;}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(5px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;}
.modal{background:#12121a;border:1px solid #2a2a3a;border-radius:16px;padding:28px;width:100%;max-width:460px;}
.modal-title{font-size:18px;font-weight:800;margin-bottom:4px;}
.modal-sub{font-size:13px;color:#6b6b80;margin-bottom:22px;line-height:1.6;}
.mfield{margin-bottom:14px;}
.mfield .lbl{margin-bottom:6px;}
.mactions{display:flex;gap:10px;margin-top:22px;}
.msavebtn{flex:1;background:linear-gradient(135deg,#2684ff,#0052cc);border:none;border-radius:10px;color:#fff;cursor:pointer;font-size:14px;font-weight:700;padding:12px;font-family:inherit;}
.mcancelbtn{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;color:#6b6b80;cursor:pointer;font-size:14px;font-weight:600;padding:12px 18px;font-family:inherit;}
.mstatus{font-size:13px;margin-top:12px;min-height:18px;}

/* Auth */
.uname{font-size:13px;color:#ffd166;font-weight:600;white-space:nowrap;}
.authtoggle{background:none;border:none;color:#6b6b80;cursor:pointer;font-size:13px;font-family:inherit;text-decoration:underline;padding:0;}

/* Admin table */
#adminTable tbody tr{border-bottom:1px solid #1e1e2a;transition:background .15s;}
#adminTable tbody tr:hover{background:rgba(255,255,255,.03);}
#adminTable td{padding:10px 10px;vertical-align:middle;}
.admin-badge{display:inline-block;font-size:11px;font-weight:700;border-radius:6px;padding:2px 8px;}
.admin-badge.locked{background:rgba(255,77,109,.12);color:#ff4d6d;border:1px solid rgba(255,77,109,.25);}
.admin-badge.active{background:rgba(34,197,94,.1);color:#22c55e;border:1px solid rgba(34,197,94,.2);}
.admin-badge.admin{background:rgba(255,209,102,.08);color:#ffd166;border:1px solid rgba(255,209,102,.2);}
.admin-ipt{background:#0a0a0f;border:1px solid #2a2a3a;border-radius:7px;color:#f0f0f5;font-size:12px;padding:5px 8px;width:170px;font-family:inherit;}
.admin-ipt:focus{outline:none;border-color:#ff4d6d;}
.admin-action{background:none;border:1px solid #2a2a3a;border-radius:7px;color:#6b6b80;cursor:pointer;font-size:12px;padding:4px 10px;font-family:inherit;white-space:nowrap;}
.admin-action:hover{border-color:#ff4d6d;color:#ff4d6d;}
.admin-action.ok{border-color:rgba(34,197,94,.4);color:#22c55e;}
.admin-action.ok:hover{background:rgba(34,197,94,.1);}
</style>
</head>
<body>
<div class="wrap">

<div class="topbar">
  <div class="logo">
    <svg viewBox="0 0 60 30" height="36" width="60" fill="none" style="flex-shrink:0" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="plg" x1="0" y1="0" x2="60" y2="0" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ff4d6d"/>
          <stop offset="0.5" stop-color="#ff8c42"/>
          <stop offset="1" stop-color="#ffd166"/>
        </linearGradient>
      </defs>
      <!-- connecting pipe -->
      <rect x="8" y="12" width="44" height="6" rx="3" fill="url(#plg)" opacity="0.28"/>
      <!-- stage nodes -->
      <circle cx="8" cy="15" r="8" fill="#ff4d6d"/>
      <circle cx="30" cy="15" r="8" fill="url(#plg)"/>
      <circle cx="52" cy="15" r="8" fill="#ffd166"/>
      <!-- icons inside nodes: briefcase, gear, checkmark -->
      <rect x="5" y="13" width="6" height="4" rx="1" fill="rgba(255,255,255,0.85)"/>
      <path d="M6.5 13v-1a1 1 0 011-1h1a1 1 0 011 1v1" stroke="rgba(255,255,255,0.85)" stroke-width="0.9" fill="none" stroke-linecap="round"/>
      <circle cx="30" cy="15" r="2.5" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.2"/>
      <circle cx="30" cy="15" r="1" fill="rgba(255,255,255,0.85)"/>
      <path d="M27.5 12.5l1.2 1.2M32.5 17.5l-1.2-1.2M27.5 17.5l1.2-1.2M32.5 12.5l-1.2 1.2" stroke="rgba(255,255,255,0.75)" stroke-width="1" stroke-linecap="round"/>
      <path d="M49 15.2l2 2 4-4" stroke="rgba(255,255,255,0.9)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    JobPipeline
  </div>
  <div class="nav">
    <button type="button" class="nbtn on" id="nb1" onclick="showTab('search')">üîç Suche</button>
    <button type="button" class="nbtn" id="nb2" onclick="showTab('saved')">
      üìå Merkzettel<span class="badge" id="badge">0</span>
    </button>
    <button type="button" class="cfgbtn" id="jiraCfgBtn" onclick="openJiraSettings()" title="Jira Einstellungen">‚ö° Jira</button>
    <div id="userBar" style="display:none;align-items:center;gap:6px;">
      <span class="uname" id="uname"></span>
      <button type="button" class="cfgbtn" id="adminBtn" style="display:none" onclick="openAdminPanel()" title="Benutzerverwaltung">‚öôÔ∏è Admin</button>
      <button type="button" class="nbtn" onclick="doLogout()">Abmelden</button>
    </div>
    <button type="button" class="nbtn" id="loginBtn" onclick="openAuthModal()">üîê Anmelden</button>
  </div>
</div>

<!-- SEARCH TAB -->
<div id="tabSearch">

  <div class="card">
    <div class="card-stripe"></div>
    <div class="lbl">üéØ Jobtitel ‚Äî Mehrfachauswahl m√∂glich</div>
    <div class="chips" id="chips">
      <button type="button" class="chip" data-t="CTO">CTO</button>
      <button type="button" class="chip" data-t="CIO">CIO</button>
      <button type="button" class="chip" data-t="CDO">CDO</button>
      <button type="button" class="chip" data-t="Head of IT">Head of IT</button>
      <button type="button" class="chip" data-t="Leiter IT">Leiter IT</button>
      <button type="button" class="chip" data-t="Direktor IT">Direktor IT</button>
      <button type="button" class="chip" data-t="IT-Manager">IT-Manager</button>
      <button type="button" class="chip" data-t="VP of Engineering">VP of Engineering</button>
    </div>
    <div class="lbl">‚úèÔ∏è Eigener Jobtitel</div>
    <div class="ftrow">
      <input type="text" class="inp" id="ftInp" placeholder="z.B. CISO, Head of Digital‚Ä¶">
      <button type="button" class="ftadd" id="ftBtn">+ Hinzuf√ºgen</button>
    </div>
    <div class="seltags" id="selTags"></div>
    <div class="hint" id="selHint" style="display:none"><span id="selCnt">0</span> Jobtitel ausgew√§hlt</div>
  </div>

  <div class="card">
    <div class="card-stripe"></div>
    <div class="lbl">üìç Ort &amp; PLZ</div>
    <div class="row2" style="margin-bottom:14px;">
      <input type="text" class="inp" id="inpLoc" placeholder="z.B. Berlin, M√ºnchen‚Ä¶">
      <input type="text" class="inp" id="inpPlz" placeholder="PLZ" maxlength="5" inputmode="numeric">
    </div>
    <div class="lbl">üì° Umkreis</div>
    <div class="rrow" id="rrowKm">
      <button type="button" class="rbtn" data-v="10">10 km</button>
      <button type="button" class="rbtn" data-v="25">25 km</button>
      <button type="button" class="rbtn on" data-v="50">50 km</button>
      <button type="button" class="rbtn" data-v="100">100 km</button>
      <button type="button" class="rbtn" data-v="150">150 km</button>
    </div>
    <div class="lbl">üìÖ Ver√∂ffentlichungsdatum</div>
    <div class="rrow" id="rrowDays">
      <button type="button" class="rbtn on" data-v="7">1 Woche</button>
      <button type="button" class="rbtn" data-v="14">2 Wochen</button>
      <button type="button" class="rbtn" data-v="30">1 Monat</button>
      <button type="button" class="rbtn" data-v="0">Egal</button>
    </div>
    <button type="button" class="gobtn" id="goBtn">üîç Stellen suchen</button>
  </div>

  <div id="errbx" style="display:none" class="errbx"></div>
  <div id="infobx" style="display:none" class="infobx"></div>
  <div id="loadbox" style="display:none"><div class="spinner"></div><div class="stxt" id="stxt">Suche‚Ä¶</div></div>
  <div id="reshdr" style="display:none" class="reshdr"></div>
  <div id="restags" class="restags"></div>
  <div id="joblist"></div>
  <div id="nores" style="display:none" class="nores">üòï Keine Ergebnisse. Anderen Suchbegriff oder gr√∂√üeren Umkreis versuchen.</div>
  <div id="platbox" style="display:none"></div>
  <div class="footer" id="footer" style="display:none">Live-Daten via Adzuna API ¬∑ Direktlinks zu 33 Portalen</div>

</div><!-- /tabSearch -->

<!-- SAVED TAB -->
<div id="tabSaved" style="display:none">
  <div class="saved-hdr">
    <div class="savtitle">üìå Merkzettel <span id="savCntTitle">0</span></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <div class="sfrow" id="sfrow">
        <button type="button" class="sfbtn on" data-s="all">Alle</button>
        <button type="button" class="sfbtn" data-s="neu">üîµ Neu</button>
        <button type="button" class="sfbtn" data-s="interessant">‚≠ê Interessant</button>
        <button type="button" class="sfbtn" data-s="beworben">‚úÖ Beworben</button>
        <button type="button" class="sfbtn" data-s="abgelehnt">‚ùå Abgelehnt</button>
        <button type="button" class="sfbtn" data-s="angebot">üéâ Angebot</button>
      </div>
      <button type="button" class="clrbtn" id="clrIgnBtn">üóë Ignorierliste leeren</button>
    </div>
  </div>
  <div id="savedList"></div>
  <div id="savEmpty" class="savempty" style="display:none">
    Noch keine Stellen gespeichert.<br>
    <span style="font-size:13px;">Klicke bei einem Suchergebnis auf üíæ Speichern.</span>
  </div>
</div>

</div><!-- /wrap -->

<!-- Auth Modal -->
<div id="authModal" class="modal-bg" style="display:none" onclick="if(event.target===this)closeAuthModal()">
  <div class="modal">
    <div class="modal-title" id="authTitle">üîê Anmelden</div>
    <div class="modal-sub" id="authSub">Melde dich an, um Stellen zu speichern und Jira zu nutzen.</div>
    <div id="authHint" class="infobx" style="display:none;margin-bottom:14px;"></div>
    <div class="mfield" id="authUserWrap">
      <label class="lbl">üë§ Benutzername</label>
      <input type="text" class="inp" id="authUser" autocomplete="username">
    </div>
    <div class="mfield" id="authEmailWrap" style="display:none">
      <label class="lbl" id="authEmailLabel">‚úâÔ∏è E-Mail-Adresse</label>
      <input type="email" class="inp" id="authEmail" autocomplete="email" placeholder="name@beispiel.de">
    </div>
    <div class="mfield" id="authPwWrap">
      <label class="lbl" id="authPwLabel">üîë Passwort</label>
      <input type="password" class="inp" id="authPw" autocomplete="current-password">
      <div id="authForgotLink" style="text-align:right;margin-top:5px;">
        <button type="button" class="authtoggle" onclick="switchToForgot()">Passwort vergessen?</button>
      </div>
    </div>
    <div class="mfield" id="authPw2Wrap" style="display:none">
      <label class="lbl">üîÅ Passwort best√§tigen</label>
      <input type="password" class="inp" id="authPw2" autocomplete="new-password">
    </div>
    <div id="authStatus" class="mstatus"></div>
    <div class="mactions">
      <button type="button" class="mcancelbtn" onclick="closeAuthModal()">Abbrechen</button>
      <button type="button" class="msavebtn" id="authSubmitBtn" onclick="doAuth()">Anmelden</button>
    </div>
    <div style="text-align:center;margin-top:16px;">
      <button type="button" class="authtoggle" id="authToggle" onclick="toggleAuthMode()">Noch kein Konto? ‚Üí Registrieren</button>
    </div>
  </div>
</div>

<!-- Jira Settings Modal -->
<div id="jiraModal" class="modal-bg" style="display:none" onclick="if(event.target===this)closeJiraSettings()">
  <div class="modal">
    <div class="modal-title">‚ö° Jira Anbindung</div>
    <div class="modal-sub">Verbinde JobPipeline mit deinem Jira-Projekt, um gespeicherte Jobs als Tickets zu exportieren.<br>Den API-Token findest du unter <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" rel="noopener" style="color:#2684ff;">id.atlassian.com ‚Üí Security ‚Üí API Tokens</a>.</div>

    <div class="mfield">
      <label class="lbl">üåê Jira Cloud Domain</label>
      <input type="text" class="inp" id="jDomain" placeholder="meinunternehmen.atlassian.net" autocomplete="off">
    </div>
    <div class="mfield">
      <label class="lbl">‚úâÔ∏è E-Mail Adresse</label>
      <input type="email" class="inp" id="jEmail" placeholder="name@unternehmen.de" autocomplete="email">
    </div>
    <div class="mfield">
      <label class="lbl">üîë API Token</label>
      <input type="password" class="inp" id="jToken" placeholder="API Token von Atlassian" autocomplete="off">
    </div>
    <div class="mfield">
      <label class="lbl">üìÅ Projekt-Key</label>
      <input type="text" class="inp" id="jProject" placeholder="z.B. JOBS" style="text-transform:uppercase;" autocomplete="off">
    </div>
    <div class="mfield">
      <label class="lbl">üé´ Issue-Typ</label>
      <input type="text" class="inp" id="jIssueType" placeholder="Task" autocomplete="off">
    </div>
    <div class="mfield">
      <label class="lbl">üîó Jira-Feld: URL <span style="color:#6b6b80;font-weight:400;">(optional)</span></label>
      <input type="text" class="inp" id="jUrlField" placeholder="customfield_10050" autocomplete="off">
    </div>
    <div class="mfield">
      <label class="lbl">üè¢ Jira-Feld: Unternehmen <span style="color:#6b6b80;font-weight:400;">(optional)</span></label>
      <input type="text" class="inp" id="jCompanyField" placeholder="customfield_10051" autocomplete="off">
      <div style="font-size:11px;color:#6b6b80;margin-top:5px;">Field-IDs: <button type="button" onclick="loadJiraFields()" style="background:none;border:none;color:#2684ff;cursor:pointer;font-size:11px;padding:0;font-family:inherit;text-decoration:underline;">Verf√ºgbare Felder anzeigen ‚Üí</button></div>
    </div>
    <div id="jiraFieldsBox" style="display:none;background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;padding:12px;margin-bottom:14px;max-height:180px;overflow-y:auto;font-size:11px;"></div>
    <div class="mfield" style="display:flex;align-items:flex-start;gap:12px;background:#0a0a0f;border:1px solid #2a2a3a;border-radius:10px;padding:13px 15px;">
      <input type="checkbox" id="jUseProxy" style="width:16px;height:16px;flex-shrink:0;margin-top:2px;cursor:pointer;accent-color:#2684ff;" checked>
      <div>
        <label for="jUseProxy" style="cursor:pointer;font-size:13px;font-weight:600;display:block;">üîÄ Lokalen Proxy verwenden <span style="color:#6b6b80;font-weight:400;">(empfohlen)</span></label>
        <div style="font-size:11px;color:#6b6b80;margin-top:3px;line-height:1.5;">Leitet Requests √ºber den Backend-Proxy (server.py). Umgeht CORS. Deaktivieren nur wenn Jira CORS f√ºr deine Domain erlaubt.</div>
      </div>
    </div>

    <div id="jiraModalStatus" class="mstatus"></div>
    <div class="mactions">
      <button type="button" class="mcancelbtn" onclick="closeJiraSettings()">Abbrechen</button>
      <button type="button" class="mcancelbtn" id="jTestBtn" onclick="testJiraConnection()" style="border-color:rgba(38,132,255,.35);color:#2684ff;">üîó Testen</button>
      <button type="button" class="msavebtn" onclick="saveJiraSettings()">üíæ Speichern</button>
    </div>
  </div>
</div>

<!-- Admin Panel Modal -->
<div id="adminModal" class="modal-bg" style="display:none" onclick="if(event.target===this)closeAdminPanel()">
  <div class="modal" style="max-width:720px;width:100%;">
    <div class="modal-title">‚öôÔ∏è Benutzerverwaltung</div>
    <div class="modal-sub">Benutzer anzeigen, sperren/entsperren, E-Mail anpassen oder Konten l√∂schen.</div>
    <div id="adminStatus" class="mstatus" style="margin-bottom:12px;"></div>
    <div style="overflow-x:auto;">
      <table id="adminTable" style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="color:#6b6b80;text-align:left;border-bottom:1px solid #2a2a3a;">
            <th style="padding:8px 10px;">Benutzer</th>
            <th style="padding:8px 10px;">E-Mail</th>
            <th style="padding:8px 10px;">Registriert</th>
            <th style="padding:8px 10px;text-align:center;">Admin</th>
            <th style="padding:8px 10px;text-align:center;">Status</th>
            <th style="padding:8px 10px;text-align:right;">Aktionen</th>
          </tr>
        </thead>
        <tbody id="adminTbody">
          <tr><td colspan="6" style="text-align:center;padding:24px;color:#6b6b80;">Wird geladen‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
    <div class="mactions" style="margin-top:20px;">
      <button type="button" class="mcancelbtn" onclick="closeAdminPanel()">Schlie√üen</button>
      <button type="button" class="msavebtn" style="flex:0;padding:10px 20px;" onclick="loadAdminUsers()">üîÑ Aktualisieren</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let km = 50, days = 7;
const titles = new Set();
const JOBS = {}; // storeId ‚Üí job object
let sfFilter = "all";

// ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ
let AUTH = { user: null };
let _authMode = "login";      // "login" | "register" | "forgot" | "reset"
let _pendingAction = null;    // callback nach erfolgreichem Login
let _resetToken = null;       // Token aus ?reset=... URL-Parameter

// ‚îÄ‚îÄ Storage ‚îÄ‚îÄ
const LS = {
  saved:      () => { try{ return JSON.parse(localStorage.getItem("jf2_saved")||"{}"); }catch(e){return {};} },
  ignored:    () => { try{ return JSON.parse(localStorage.getItem("jf2_ign")||"[]"); }catch(e){return [];} },
  setSaved:   d => { localStorage.setItem("jf2_saved", JSON.stringify(d)); refreshBadge(); syncUserData(); },
  setIgnored: a => { localStorage.setItem("jf2_ign",   JSON.stringify(a)); syncUserData(); }
};

function jobKey(j){ return (j.redirect_url||(j.title+"|"+(j.company?.display_name||""))).slice(0,180); }

function refreshBadge(){
  const n = Object.keys(LS.saved()).length;
  const b = document.getElementById("badge");
  b.textContent = n; b.style.display = n ? "block" : "none";
  document.getElementById("savCntTitle").textContent = n;
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function showTab(t){
  document.getElementById("tabSearch").style.display = t==="search"?"block":"none";
  document.getElementById("tabSaved").style.display  = t==="saved" ?"block":"none";
  document.getElementById("nb1").classList.toggle("on", t==="search");
  document.getElementById("nb2").classList.toggle("on", t==="saved");
  if(t==="saved") renderSaved();
}

// ‚îÄ‚îÄ Chips ‚îÄ‚îÄ
document.getElementById("chips").addEventListener("click", e => {
  const btn = e.target.closest(".chip");
  if(!btn) return;
  const t = btn.dataset.t;
  if(titles.has(t)){ titles.delete(t); btn.classList.remove("on"); }
  else             { titles.add(t);    btn.classList.add("on"); }
  renderSelTags();
});

document.getElementById("ftBtn").addEventListener("click", addFt);
document.getElementById("ftInp").addEventListener("keydown", e => { if(e.key==="Enter"){ e.preventDefault(); addFt(); } });

function addFt(){
  const v = document.getElementById("ftInp").value.trim();
  if(!v) return;
  titles.add(v);
  document.getElementById("ftInp").value = "";
  renderSelTags();
}

function renderSelTags(){
  const wrap = document.getElementById("selTags");
  wrap.innerHTML = "";
  titles.forEach(t => {
    const span = document.createElement("span");
    span.className = "stag";
    span.appendChild(document.createTextNode(t));
    const x = document.createElement("button");
    x.type="button"; x.className="stag-x"; x.textContent="√ó";
    x.addEventListener("click", () => {
      titles.delete(t);
      document.querySelectorAll(".chip").forEach(c=>{ if(c.dataset.t===t) c.classList.remove("on"); });
      renderSelTags();
    });
    span.appendChild(x);
    wrap.appendChild(span);
  });
  document.getElementById("selHint").style.display = titles.size ? "block":"none";
  document.getElementById("selCnt").textContent = titles.size;
}

// ‚îÄ‚îÄ Radio rows ‚îÄ‚îÄ
document.getElementById("rrowKm").addEventListener("click", e => {
  const btn = e.target.closest(".rbtn");
  if(!btn) return;
  document.querySelectorAll("#rrowKm .rbtn").forEach(b=>b.classList.remove("on"));
  btn.classList.add("on");
  km = parseInt(btn.dataset.v);
});
document.getElementById("rrowDays").addEventListener("click", e => {
  const btn = e.target.closest(".rbtn");
  if(!btn) return;
  document.querySelectorAll("#rrowDays .rbtn").forEach(b=>b.classList.remove("on"));
  btn.classList.add("on");
  days = parseInt(btn.dataset.v);
});

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ
document.getElementById("goBtn").addEventListener("click", doSearch);

async function doSearch(){
  const loc = document.getElementById("inpLoc").value.trim();
  const plz = document.getElementById("inpPlz").value.trim();
  const where = plz ? (loc ? plz+" "+loc : plz) : loc;

  if(!titles.size){ showErr("Bitte mindestens einen Jobtitel w√§hlen."); return; }
  if(!where)      { showErr("Bitte Ort oder PLZ eingeben."); return; }

  hide("errbx"); hide("infobx"); hide("nores"); hide("platbox"); hide("footer"); hide("reshdr");
  document.getElementById("restags").innerHTML = "";
  document.getElementById("joblist").innerHTML = "";
  show("loadbox");
  document.getElementById("goBtn").disabled = true;

  const arr = Array.from(titles);
  const country = where.toLowerCase().includes("wien")||where.toLowerCase().includes("√∂sterreich")?"at"
                : where.toLowerCase().includes("z√ºrich")||where.toLowerCase().includes("schweiz")?"ch":"de";
  document.getElementById("stxt").textContent = arr.length>1 ? "Suche nach "+arr.length+" Jobtiteln parallel‚Ä¶" : "Suche nach ‚Äû"+arr[0]+"\"‚Ä¶";

  try {
    const results = await Promise.all(arr.map(title => {
      const p = new URLSearchParams({what:title,where,distance:km,country});
      return fetch("/jobs?"+p)
        .then(r=>r.json()).then(d=>({title,list:d.results||[],count:d.count||0})).catch(()=>({title,list:[],count:0}));
    }));

    const saved = LS.saved(), ign = LS.ignored();
    const seen = new Set(), merged = [];
    let total=0, skipSaved=0, skipIgn=0;
    const cutoff = days>0 ? Date.now()-days*86400000 : 0;

    results.forEach(({title,list,count}) => {
      total += count;
      list.forEach(j => {
        if(cutoff>0 && j.created && new Date(j.created)<cutoff) return;
        const k = jobKey(j);
        if(ign.includes(k)){ skipIgn++; return; }
        if(saved[k])        { skipSaved++; return; }
        if(!seen.has(k))    { seen.add(k); merged.push({...j, _t:title}); }
      });
    });
    merged.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));

    if(skipSaved||skipIgn){
      const parts=[];
      if(skipSaved) parts.push("<b>"+skipSaved+"</b> gespeichert");
      if(skipIgn)   parts.push("<b>"+skipIgn+"</b> ignoriert");
      document.getElementById("infobx").innerHTML="‚ÑπÔ∏è "+parts.join(" ¬∑ ")+" ‚Äî nicht mehr angezeigt.";
      show("infobx");
    }

    renderResults(merged, total, arr, where);
  } catch(ex){ showErr("Fehler: "+ex.message); }

  hide("loadbox");
  document.getElementById("goBtn").disabled = false;
}

// ‚îÄ‚îÄ Render results ‚îÄ‚îÄ
function renderResults(jobs, total, arr, where){
  const dLabel = days===7?"letzte Woche":days===14?"letzte 2 Wochen":days===30?"letzter Monat":"alle Daten";

  if(!jobs.length){ show("nores"); }
  else {
    const hdr = document.getElementById("reshdr");
    hdr.innerHTML = "<span class='rc'>"+jobs.length+"</span> neue Stellen &nbsp;<span class='rt'>("+total.toLocaleString("de-DE")+" gesamt ¬∑ "+km+" km ¬∑ "+where+" ¬∑ "+dLabel+")</span>";
    show("reshdr");

    const rt = document.getElementById("restags");
    arr.forEach(t => {
      const n = jobs.filter(j=>j._t===t).length;
      const s = document.createElement("span"); s.className="rtag"; s.textContent=t+": "+n+" Treffer";
      rt.appendChild(s);
    });

    const list = document.getElementById("joblist");
    jobs.forEach(j => {
      const id = "j"+Math.random().toString(36).slice(2,9);
      JOBS[id] = j;
      const sal = fmtSal(j.salary_min,j.salary_max);
      const ct  = j.contract_type==="permanent"?"Festanstellung":j.contract_type==="part_time"?"Teilzeit":j.contract_type||"";
      const desc= (j.description||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim().slice(0,200);
      const card = document.createElement("div");
      card.className="jcard"; card.id="jw"+id;
      card.innerHTML =
        '<div class="jcard-top">'+
          '<div>'+
            '<div class="jtitle">'+esc(j.title||"")+'</div>'+
            '<div class="jco">'+esc(j.company?.display_name||"")+'</div>'+
            '<div class="jmeta">'+
              (j.location?.display_name?'<span class="jmi">üìç '+esc(j.location.display_name)+'</span>':'')+
              (ct?'<span class="jmi">üíº '+ct+'</span>':'')+
              (j.created?'<span class="jmi">üïê '+ago(j.created)+'</span>':'')+
            '</div>'+
          '</div>'+
          '<div class="jright">'+
            '<span class="jbadge">Adzuna</span>'+
            '<span class="jas">'+esc(j._t)+'</span>'+
            (sal?'<span class="jsal">'+sal+'</span>':'')+
          '</div>'+
        '</div>'+
        (desc?'<div class="jdesc">'+esc(desc)+'‚Ä¶ <a class="jlink" href="'+esc(j.redirect_url||"")+'" target="_blank" rel="noopener">‚Üí √ñffnen</a></div>':'')+
        '<div class="jactions">'+
          '<button type="button" class="savebtn" data-id="'+id+'">üíæ Speichern</button>'+
          '<button type="button" class="skipbtn" data-id="'+id+'">üö´ Ignorieren</button>'+
          '<span class="jnote">Wird bei n√§chster Suche ausgeblendet</span>'+
        '</div>';
      list.appendChild(card);
    });

    // Single delegated listener on the list
    list.addEventListener("click", e => {
      const sb = e.target.closest(".savebtn");
      const sk = e.target.closest(".skipbtn");
      if(sb){ e.stopPropagation(); saveJob(sb.dataset.id); }
      if(sk){ e.stopPropagation(); skipJob(sk.dataset.id); }
    });
  }

  renderPlats(arr, where);
}

// ‚îÄ‚îÄ Save / Skip ‚îÄ‚îÄ
function saveJob(id){
  requireAuth("Zum Speichern bitte anmelden.", () => {
    const j = JOBS[id]; if(!j) return;
    const k = jobKey(j);
    const saved = LS.saved();
    if(!saved[k]){
      saved[k] = {
        key:k, title:j.title||"", company:j.company?.display_name||"",
        location:j.location?.display_name||"", url:j.redirect_url||"",
        salary_min:j.salary_min, salary_max:j.salary_max,
        contract_type:j.contract_type, created:j.created, searchedAs:j._t||"",
        savedAt:new Date().toISOString(), status:"neu", note:""
      };
      LS.setSaved(saved);
    }
    fadeOut("jw"+id);
  });
}
function skipJob(id){
  requireAuth("Zum Ignorieren bitte anmelden.", () => {
    const j = JOBS[id]; if(!j) return;
    const k = jobKey(j);
    const ign = LS.ignored();
    if(!ign.includes(k)){ ign.push(k); LS.setIgnored(ign); }
    fadeOut("jw"+id);
  });
}
function fadeOut(id){
  const el = document.getElementById(id);
  if(el){ el.style.transition="opacity .3s,transform .3s"; el.style.opacity="0"; el.style.transform="scale(0.98)"; setTimeout(()=>el.remove(),320); }
}

// ‚îÄ‚îÄ Saved view ‚îÄ‚îÄ
document.getElementById("sfrow").addEventListener("click", e => {
  const btn = e.target.closest(".sfbtn"); if(!btn) return;
  document.querySelectorAll(".sfbtn").forEach(b=>b.classList.remove("on"));
  btn.classList.add("on"); sfFilter=btn.dataset.s; renderSaved();
});
document.getElementById("clrIgnBtn").addEventListener("click", () => {
  if(confirm("Ignorierliste leeren? Diese Stellen erscheinen dann wieder.")) LS.setIgnored([]);
});

function renderSaved(){
  refreshBadge();
  const all = Object.values(LS.saved()).sort((a,b)=>new Date(b.savedAt)-new Date(a.savedAt));
  const list = sfFilter==="all" ? all : all.filter(j=>j.status===sfFilter);
  const el = document.getElementById("savedList");
  const empty = document.getElementById("savEmpty");
  el.innerHTML="";
  if(!list.length){ empty.style.display="block"; return; }
  empty.style.display="none";

  list.forEach(j => {
    const sal = fmtSal(j.salary_min,j.salary_max);
    const date = new Date(j.savedAt).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"});
    const cid = "sc"+Math.random().toString(36).slice(2,9);
    const card = document.createElement("div");
    card.className="scard"; card.id=cid;
    card.innerHTML =
      '<div class="scard-top">'+
        '<div class="scard-info">'+
          '<div class="sc-title"><a href="'+esc(j.url)+'" target="_blank" rel="noopener">'+esc(j.title)+'</a></div>'+
          '<div class="sc-co">'+esc(j.company)+'</div>'+
          '<div class="sc-meta">'+
            (j.location?'<span class="jmi">üìç '+esc(j.location)+'</span>':'')+
            (j.contract_type==="permanent"?'<span class="jmi">üíº Festanstellung</span>':'')+
            (sal?'<span class="jmi">üí∞ '+sal+'</span>':'')+
            '<span class="sc-date">Gespeichert '+date+'</span>'+
          '</div>'+
        '</div>'+
        '<div class="scard-right">'+
          '<select class="ssel" data-key="'+esc(j.key)+'">'+
            ['neu','interessant','beworben','abgelehnt','angebot'].map(s=>
              '<option value="'+s+'"'+(j.status===s?' selected':'')+'>'+
              {neu:'üîµ Neu',interessant:'‚≠ê Interessant',beworben:'‚úÖ Beworben',abgelehnt:'‚ùå Abgelehnt',angebot:'üéâ Angebot'}[s]+'</option>'
            ).join('')+
          '</select>'+
          (sal?'<span class="jsal">'+sal+'</span>':'')+
        '</div>'+
      '</div>'+
      '<textarea class="snote" id="sn'+cid+'" placeholder="Notizen‚Ä¶ Ansprechpartner, Gehaltswunsch, Gespr√§chsnotizen‚Ä¶" rows="3">'+esc(j.note||"")+'</textarea>'+
      '<div class="sactions">'+
        '<button type="button" class="nsavebtn" data-cid="'+cid+'" data-key="'+esc(j.key)+'">üíæ Notiz speichern</button>'+
        '<span class="nhint" id="nh'+cid+'">‚úì Gespeichert</span>'+
        jiraActionBtn(j)+
        '<button type="button" class="delbtn" data-cid="'+cid+'" data-key="'+esc(j.key)+'">üóë Entfernen</button>'+
      '</div>';
    el.appendChild(card);
  });

  // Delegated events
  el.addEventListener("change", e => {
    const sel = e.target.closest(".ssel"); if(!sel) return;
    const saved = LS.saved(); if(saved[sel.dataset.key]){ saved[sel.dataset.key].status=sel.value; LS.setSaved(saved); }
  });
  el.addEventListener("click", e => {
    const nb = e.target.closest(".nsavebtn");
    const db = e.target.closest(".delbtn");
    const jb = e.target.closest(".jirabtn[data-key]");
    if(jb){ exportToJira(jb.dataset.key, jb); }
    if(nb){
      const saved=LS.saved(); const cid=nb.dataset.cid; const k=nb.dataset.key;
      const ta=document.getElementById("sn"+cid);
      if(saved[k] && ta){ saved[k].note=ta.value; LS.setSaved(saved); }
      const hint=document.getElementById("nh"+cid);
      if(hint){ hint.style.display="inline"; setTimeout(()=>hint.style.display="none",2000); }
    }
    if(db){
      const saved=LS.saved(); delete saved[db.dataset.key]; LS.setSaved(saved);
      const card=document.getElementById(db.dataset.cid);
      if(card){ card.style.opacity="0"; card.style.transition="opacity .25s"; setTimeout(()=>{ card.remove(); renderSaved(); },260); }
    }
  });
}

// ‚îÄ‚îÄ Platforms ‚îÄ‚îÄ
function renderPlats(arr, where){
  const t0=encodeURIComponent(arr[0]||""), l=encodeURIComponent(where), r=km;
  const GRP=[
    {h:"üíª IT & Tech ‚Äî Testsieger 2025",hc:"it-hdr",list:[
      {n:"Jobvector",i:"ü•á",s:"#1 IT 2025",aw:1,u:()=>`https://www.jobvector.de/jobs/?q=${t0}&l=${l}&radius=${r}`},
      {n:"Heise Jobs",i:"üî¥",s:"Dev & Admin",aw:0,u:()=>`https://jobs.heise.de/suche?q=${t0}&l=${l}&radius=${r}`},
      {n:"t3n Jobs",i:"üü†",s:"Digital & Tech",aw:0,u:()=>`https://t3n.de/jobs/search/?q=${t0}&location=${l}`},
      {n:"DEVjobs",i:"‚ö°",s:"Entwickler",aw:0,u:()=>`https://devjobs.de/jobs?q=${t0}&location=${l}`},
      {n:"GULP",i:"üîß",s:"IT-Freelance",aw:0,u:()=>`https://www.gulp.de/gulp2/g/jobs/search;q=${t0};location=${l}`},
      {n:"Computerwoche",i:"üñ•Ô∏è",s:"IT-Management",aw:0,u:()=>`https://jobs.computerwoche.de/suche?q=${t0}&l=${l}`},
      {n:"ITjobs.de",i:"‚öôÔ∏è",s:"Nur IT",aw:0,u:()=>`https://www.itjobs.de/jobs?q=${t0}&where=${l}&radius=${r}`},
      {n:"Get in IT",i:"üéØ",s:"IT-Karriere",aw:0,u:()=>`https://www.get-in-it.de/jobs?q=${t0}&location=${l}`},
      {n:"Stack Overflow",i:"üî∂",s:"Entwickler weltweit",aw:0,u:()=>`https://stackoverflow.com/jobs?q=${t0}&l=${l}&d=${r}&u=Km`},
      {n:"ICTJob.de",i:"üì°",s:"IT & Telekom",aw:0,u:()=>`https://www.ictjob.de/jobs?keywords=${t0}&location=${l}`},
    ]},
    {h:"üëî C-Level & Executive Search",hc:"ex-hdr",list:[
      {n:"Korn Ferry",i:"üåç",s:"Global #1",aw:1,u:()=>`https://jobs.kornferry.com/?q=${t0}&location=${l}`},
      {n:"Spencer Stuart",i:"üåê",s:"Global CxO",aw:0,u:()=>`https://de.spencerstuart.com/what-we-do/our-capabilities/executive-search`},
      {n:"Egon Zehnder",i:"‚≠ê",s:"CxO & Board",aw:0,u:()=>`https://www.egonzehnder.com/open-positions?q=${t0}`},
      {n:"Heidrick",i:"üíé",s:"Leadership",aw:0,u:()=>`https://www.heidrick.com/en/open-positions?q=${t0}`},
      {n:"Russell Reynolds",i:"üîπ",s:"C-Suite Global",aw:0,u:()=>`https://www.russellreynolds.com/en/open-positions?q=${t0}`},
      {n:"Odgers",i:"üéØ",s:"Intl. C-Level",aw:0,u:()=>`https://www.odgersberndtson.com/de/offene-stellen?q=${t0}`},
      {n:"Page Executive",i:"üìÑ",s:"CIO/CTO Europa",aw:0,u:()=>`https://www.pageexecutive.com/jobs/${t0}/europe`},
      {n:"Headgate",i:"üñ•Ô∏è",s:"#1 IT C-Level",aw:1,u:()=>`https://head-gate.de/offene-positionen/`},
      {n:"TechMinds",i:"ü§ñ",s:"IT C-Level 14‚Äì30d",aw:1,u:()=>`https://techminds.de/jobs?q=${t0}&location=${l}`},
      {n:"Nigel Wright",i:"üá¨üáß",s:"CIO/CTO Spezialist",aw:0,u:()=>`https://www.nigelwright.com/de/cio-headhunter-deutschland`},
      {n:"CareerTeam",i:"üí°",s:"Digital Executive",aw:0,u:()=>`https://www.careerteam.de/de-roles/cio`},
      {n:"MEYHEADHUNTER",i:"‚öôÔ∏è",s:"3√ó Testsieger",aw:1,u:()=>`https://www.meyheadhunter.de/`},
      {n:"Schaffmann",i:"üèÜ",s:"SZ Beste 2025",aw:1,u:()=>`https://schaffmann-consultants.de/headhunter-c-level/`},
      {n:"Kienbaum",i:"üî∑",s:"DACH Exec Search",aw:0,u:()=>`https://www.kienbaum.com/de/jobs/?search=${t0}`},
      {n:"Kontrast",i:"üîå",s:"CIO/CTO seit 1993",aw:0,u:()=>`https://www.kontrast-gmbh.de/de/stellenangebote/?q=${t0}`},
      {n:"HAPEKO",i:"üîë",s:"C-Level & IT",aw:0,u:()=>`https://www.hapeko.de/jobs/?s=${t0}`},
      {n:"Experteer",i:"üè¢",s:"ab 60k‚Ç¨ Portal",aw:0,u:()=>`https://www.experteer.de/search?q=${t0}&location=${l}&radius=${r}`},
      {n:"LinkedIn Exec",i:"üíº",s:"C-Level Filter",aw:0,u:()=>`https://www.linkedin.com/jobs/search/?keywords=${t0}&location=${l}&distance=${r}&f_E=5%2C6`},
      {n:"The Ladders",i:"üí∞",s:"100k+ Jobs",aw:0,u:()=>`https://www.theladders.com/jobs/${t0}`},
    ]},
    {h:"üîç Generelle Portale",hc:"gn-hdr",list:[
      {n:"StepStone",i:"üìã",s:"#1 Generalist",aw:1,u:()=>`https://www.stepstone.de/work/ergebnisliste/?ke=${t0}&la=${l}&ws=${r}KM`},
      {n:"Indeed",i:"üîç",s:"Gr√∂√üte Reichweite",aw:0,u:()=>`https://de.indeed.com/jobs?q=${t0}&l=${l}&radius=${r}`},
      {n:"LinkedIn",i:"üíº",s:"Netzwerk & Jobs",aw:0,u:()=>`https://www.linkedin.com/jobs/search/?keywords=${t0}&location=${l}&distance=${r}`},
      {n:"XING",i:"ü§ù",s:"DACH-Netzwerk",aw:0,u:()=>`https://www.xing.com/jobs/search?keywords=${t0}&location=${l}&radius=${r}`},
      {n:"Jobware",i:"üîß",s:"Top 3 Generalist",aw:1,u:()=>`https://www.jobware.de/jobsuche/?searchString=${t0}&location=${l}&distance=${r}`},
      {n:"Bundesagentur",i:"üèõÔ∏è",s:"Offizielle Jobb√∂rse",aw:0,u:()=>`https://www.arbeitsagentur.de/jobsuche/suche?was=${t0}&wo=${l}&umkreis=${r}&angebotsart=1`},
      {n:"HeyJobs",i:"‚ú®",s:"KI-Matching #1",aw:1,u:()=>`https://www.heyjobs.co/de-de/jobs?q=${t0}&location=${l}`},
      {n:"Glassdoor",i:"üåê",s:"Bewertungen+Jobs",aw:0,u:()=>`https://www.glassdoor.de/Job/index.htm?sc.keyword=${t0}&locName=${l}`},
      {n:"Kimeta",i:"üî∂",s:"Metasuche",aw:1,u:()=>`https://www.kimeta.de/jobs?q=${t0}&where=${l}&radius=${r}`},
      {n:"Jooble",i:"‚ö°",s:"Aggregator",aw:0,u:()=>`https://de.jooble.org/jobs-${t0}/${l}`},
      {n:"Stellenanzeigen",i:"üì∞",s:"3,5 Mio/Monat",aw:0,u:()=>`https://www.stellenanzeigen.de/job-suche/${t0}/?q=${t0}&lo=${l}`},
    ]},
  ];

  const box = document.getElementById("platbox");
  box.innerHTML="";
  const lbl=document.createElement("div");
  lbl.style.cssText="font-size:12px;color:#6b6b80;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;";
  lbl.textContent="Weitersuchen ‚Äî mit deiner Suche vorausgef√ºllt";
  box.appendChild(lbl);

  GRP.forEach(g=>{
    const sec=document.createElement("div"); sec.className="platsec";
    const h=document.createElement("div"); h.className="plathdr "+g.hc; h.textContent=g.h;
    const gr=document.createElement("div"); gr.className="platgrd";
    g.list.forEach(p=>{
      const a=document.createElement("a"); a.href=p.u(); a.target="_blank"; a.rel="noopener"; a.className="plink";
      const i=document.createElement("span"); i.className="pi"; i.textContent=p.i;
      const n=document.createElement("span"); n.textContent=p.n;
      const s=document.createElement("span"); s.className="ps"; s.textContent=p.s;
      a.appendChild(i); a.appendChild(n); a.appendChild(s);
      if(p.aw){ const aw=document.createElement("span"); aw.className="paw"; aw.textContent="‚≠ê Testsieger"; a.appendChild(aw); }
      gr.appendChild(a);
    });
    sec.appendChild(h); sec.appendChild(gr);
    box.appendChild(sec);
  });
  show("platbox"); show("footer");
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function esc(s){ const d=document.createElement("div"); d.textContent=String(s||""); return d.innerHTML; }
function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }
function showErr(m){ document.getElementById("errbx").textContent="‚ö†Ô∏è "+m; show("errbx"); hide("loadbox"); }
function ago(d){
  const days=Math.round((Date.now()-new Date(d))/86400000);
  if(days===0) return "heute"; if(days===1) return "gestern";
  if(days<30) return "vor "+days+" Tagen";
  return "vor "+Math.round(days/30)+" Mon.";
}
function fmtSal(mn,mx){
  const f=n=>new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(n);
  if(mn&&mx) return f(mn)+" ‚Äì "+f(mx); if(mn) return "ab "+f(mn); if(mx) return "bis "+f(mx); return null;
}

// ‚îÄ‚îÄ Jira Integration ‚îÄ‚îÄ
const JIRA = {
  get: () => { try{ return JSON.parse(localStorage.getItem("jf2_jira")||"{}"); }catch(e){return {};} },
  set: d => { localStorage.setItem("jf2_jira", JSON.stringify(d)); syncUserData(); }
};

function jiraConfigured(){ const c=JIRA.get(); return !!(c.domain&&c.email&&c.token&&c.project); }

function updateJiraCfgBtn(){
  const btn = document.getElementById("jiraCfgBtn");
  if(btn) btn.classList.toggle("active", jiraConfigured());
}

function openJiraSettings(){
  if(!AUTH.user){ openAuthModal("Zum Einrichten von Jira bitte anmelden."); return; }
  const c = JIRA.get();
  document.getElementById("jDomain").value    = c.domain    || "";
  document.getElementById("jEmail").value     = c.email     || "";
  document.getElementById("jToken").value     = c.token     || "";
  document.getElementById("jProject").value   = c.project   || "";
  document.getElementById("jIssueType").value   = c.issueType   || "Task";
  document.getElementById("jUrlField").value     = c.urlField     || "";
  document.getElementById("jCompanyField").value = c.companyField || "";
  document.getElementById("jUseProxy").checked   = c.useProxy !== false;
  document.getElementById("jiraFieldsBox").style.display = "none";
  document.getElementById("jiraModalStatus").innerHTML = "";
  document.getElementById("jiraModal").style.display = "flex";
}

function closeJiraSettings(){
  document.getElementById("jiraModal").style.display = "none";
}

function saveJiraSettings(){
  const domain    = document.getElementById("jDomain").value.trim().replace(/^https?:\/\//,"").replace(/\/+$/,"");
  const email     = document.getElementById("jEmail").value.trim();
  const token     = document.getElementById("jToken").value.trim();
  const project   = document.getElementById("jProject").value.trim().toUpperCase();
  const issueType    = document.getElementById("jIssueType").value.trim() || "Task";
  const urlField     = document.getElementById("jUrlField").value.trim();
  const companyField = document.getElementById("jCompanyField").value.trim();
  const useProxy     = document.getElementById("jUseProxy").checked;
  const st           = document.getElementById("jiraModalStatus");

  if(!domain||!email||!token||!project){
    st.innerHTML = '<span style="color:#ff4d6d">\u26A0\uFE0F Bitte alle Pflichtfelder ausf\u00FCller.</span>';
    return;
  }
  JIRA.set({domain, email, token, project, issueType, urlField, companyField, useProxy});
  st.innerHTML = '<span style="color:#22c55e">\u2713 Einstellungen gespeichert</span>';
  updateJiraCfgBtn();
  setTimeout(closeJiraSettings, 1200);
}

function jiraActionBtn(j){
  if(j.jiraKey){
    const cfg = JIRA.get();
    const url = cfg.domain ? "https://"+cfg.domain+"/browse/"+esc(j.jiraKey) : "#";
    return '<a href="'+url+'" target="_blank" rel="noopener" class="jirabtn ok">\u2713 '+esc(j.jiraKey)+'</a>';
  }
  return '<button type="button" class="jirabtn" data-key="'+esc(j.key)+'">\u26A1 Nach Jira</button>';
}

async function exportToJira(key, btn){
  const cfg = JIRA.get();
  if(!cfg.domain||!cfg.email||!cfg.token||!cfg.project){ openJiraSettings(); return; }

  const saved = LS.saved();
  const job   = saved[key];
  if(!job) return;

  if(btn){ btn.disabled=true; btn.textContent="\u23F3 Exportiere\u2026"; }

  const auth    = btoa(cfg.email+":"+cfg.token);
  const summary = (job.title||"Job")+" @ "+(job.company||"");

  // Atlassian Document Format (ADF)
  const para = (parts) => ({ type:"paragraph", content:parts });
  const bold = (t)     => ({ type:"text", text:t, marks:[{type:"strong"}] });
  const text = (t)     => ({ type:"text", text:t });
  const link = (t,u)   => ({ type:"text", text:t, marks:[{type:"link",attrs:{href:u}}] });

  const rows = [];
  rows.push(para([bold("Jobtitel: "),       text(job.title||"\u2013")]));
  rows.push(para([bold("Unternehmen: "),    text(job.company||"\u2013")]));
  if(job.location) rows.push(para([bold("Standort: "),      text(job.location)]));
  const sal = fmtSal(job.salary_min, job.salary_max);
  if(sal)          rows.push(para([bold("Gehalt: "),        text(sal)]));
  if(job.url)      rows.push(para([bold("Stellenanzeige: "), link(job.url, job.url)]));
  if(job.searchedAs) rows.push(para([bold("Gesucht als: "), text(job.searchedAs)]));
  if(job.note){
    rows.push({ type:"rule" });
    rows.push(para([bold("Notizen:")]));
    rows.push(para([text(job.note)]));
  }

  const fields = {
    project:     { key: cfg.project },
    summary:     summary,
    description: { type:"doc", version:1, content:rows },
    issuetype:   { name: cfg.issueType||"Task" }
  };
  if(cfg.urlField     && job.url)     fields[cfg.urlField]     = job.url;
  if(cfg.companyField && job.company) fields[cfg.companyField] = job.company;
  const body = { fields };

  const useProxy = cfg.useProxy !== false;
  const apiUrl   = useProxy
    ? "/jira/issue"
    : "https://"+cfg.domain+"/rest/api/3/issue";
  const hdrs = {
    "Authorization": "Basic "+auth,
    "Content-Type":  "application/json",
    "Accept":        "application/json"
  };
  if(useProxy) hdrs["X-Jira-Domain"] = cfg.domain;

  const doFetch = (f) => fetch(apiUrl, { method:"POST", headers:hdrs, body:JSON.stringify({fields:f}) });

  function jiraErrMsg(err, status){
    if(status===401) return "Zugangsdaten ung√ºltig ‚Äî E-Mail oder API Token falsch";
    if(status===403) return "Keine Berechtigung f√ºr dieses Projekt";
    if(status===404) return "Projekt-Key nicht gefunden";
    if(err.errors && Object.keys(err.errors).length)
      return Object.entries(err.errors).map(([k,v])=>k+": "+v).join(" | ");
    return (err.errorMessages&&err.errorMessages[0]) || err.message || ("HTTP "+status);
  }

  function jiraSuccess(data, btn){
    const sv = LS.saved();
    if(sv[key]){ sv[key].jiraKey = data.key; LS.setSaved(sv); }
    if(btn){
      const url = "https://"+cfg.domain+"/browse/"+data.key;
      const a = document.createElement("a");
      a.href=url; a.target="_blank"; a.rel="noopener";
      a.className="jirabtn ok"; a.textContent="\u2713 "+data.key;
      btn.replaceWith(a);
    }
  }

  try {
    let resp = await doFetch(fields);

    // If 400 and custom fields are configured ‚Üí retry without them
    if(resp.status===400 && (cfg.urlField||cfg.companyField)){
      const fallback = {...fields};
      delete fallback[cfg.urlField];
      delete fallback[cfg.companyField];
      const resp2 = await doFetch(fallback);
      if(resp2.ok){
        const data = await resp2.json();
        jiraSuccess(data, btn);
        const warn = document.createElement("div");
        warn.style.cssText = "position:fixed;bottom:1rem;right:1rem;background:#f59e0b;color:#fff;padding:.75rem 1rem;border-radius:.5rem;z-index:9999;font-size:.85rem;max-width:22rem;line-height:1.4";
        warn.textContent = "\u26A0\uFE0F Ticket erstellt, aber Custom Fields konnten nicht gesetzt werden \u2014 Felder im Jira-Screen des Issue-Typs aktivieren oder Field-IDs pr\u00FCfen";
        document.body.appendChild(warn);
        setTimeout(()=>warn.remove(), 7000);
        return;
      }
      // fallback also failed ‚Äî show that error
      const err2 = await resp2.json().catch(()=>({}));
      const msg2 = jiraErrMsg(err2, resp2.status);
      if(btn){ btn.disabled=false; btn.textContent="\u26A0\uFE0F Fehler"; btn.classList.add("err"); btn.title=msg2; }
      return;
    }

    if(resp.ok){
      const data = await resp.json();
      jiraSuccess(data, btn);
    } else {
      const err = await resp.json().catch(()=>({}));
      const msg = jiraErrMsg(err, resp.status);
      if(btn){ btn.disabled=false; btn.textContent="\u26A0\uFE0F Fehler"; btn.classList.add("err"); btn.title=msg; }
    }
  } catch(ex){
    const isProxy = (JIRA.get().useProxy !== false);
    const hint = isProxy ? " (l√§uft server.py / Docker?)" : "";
    if(btn){ btn.disabled=false; btn.textContent="\u26A0\uFE0F Nicht erreichbar"; btn.classList.add("err"); btn.title=ex.message+hint; }
  }
}

async function loadJiraFields(){
  const domain   = document.getElementById("jDomain").value.trim().replace(/^https?:\/\//,"").replace(/\/+$/,"");
  const email    = document.getElementById("jEmail").value.trim();
  const token    = document.getElementById("jToken").value.trim();
  const project  = document.getElementById("jProject").value.trim().toUpperCase();
  const useProxy = document.getElementById("jUseProxy").checked;
  const box      = document.getElementById("jiraFieldsBox");

  if(!domain||!email||!token||!project){
    box.style.display="block";
    box.innerHTML='<span style="color:#ff4d6d">\u26A0\uFE0F Bitte zuerst Domain, E-Mail, Token und Projekt-Key eingeben.</span>';
    return;
  }
  box.style.display="block";
  box.innerHTML='<span style="color:#6b6b80">\u23F3 Lade Felder\u2026</span>';

  const auth = btoa(email+":"+token);
  const hdrs = { "Authorization":"Basic "+auth, "Accept":"application/json" };
  let url;
  if(useProxy){ url=`/jira/fields?project=${encodeURIComponent(project)}`; hdrs["X-Jira-Domain"]=domain; }
  else         { url=`https://${domain}/rest/api/3/issue/createmeta/${encodeURIComponent(project)}/issuetypes`; }

  try {
    const resp = await fetch(url, { headers:hdrs });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok){
      box.innerHTML='<span style="color:#ff4d6d">\u274C '+(data.errorMessages?.[0]||data.error||"HTTP "+resp.status)+'</span>';
      return;
    }
    // Fetch fields for first issue type
    const types = data.issueTypes || data.values || [];
    if(!types.length){ box.innerHTML='<span style="color:#6b6b80">Keine Issue-Typen gefunden.</span>'; return; }
    const typeId = types[0].id;
    const furl = useProxy
      ? `/jira/fields?project=${encodeURIComponent(project)}&issuetype=${typeId}`
      : `https://${domain}/rest/api/3/issue/createmeta/${encodeURIComponent(project)}/issuetypes/${typeId}`;
    const fr = await fetch(furl, { headers:hdrs });
    const fd = await fr.json().catch(()=>({}));
    const fieldMap = fd.fields || {};
    const rows = Object.entries(fieldMap)
      .filter(([id])=>id.startsWith("customfield_")||["summary","description","url","labels"].includes(id))
      .sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0]));
    if(!rows.length){ box.innerHTML='<span style="color:#6b6b80">Keine Custom Fields gefunden.</span>'; return; }

    // Auto-detect URL and Unternehmen fields by name
    const urlKw     = ["url","link","webseite","website","stellenanzeige"];
    const companyKw = ["unternehmen","company","firma","arbeitgeber","organisation"];
    const urlInp     = document.getElementById("jUrlField");
    const companyInp = document.getElementById("jCompanyField");
    let autoUrl="", autoCompany="";
    for(const [id,f] of rows){
      const n = (f.name||"").toLowerCase();
      if(!autoUrl     && urlKw.some(k=>n.includes(k)))     { autoUrl=id; }
      if(!autoCompany && companyKw.some(k=>n.includes(k))) { autoCompany=id; }
    }
    const didUrl     = autoUrl     && !urlInp.value;
    const didCompany = autoCompany && !companyInp.value;
    if(didUrl)     urlInp.value     = autoUrl;
    if(didCompany) companyInp.value = autoCompany;

    const autoHint = (didUrl||didCompany)
      ? `<div style="color:#22c55e;margin-bottom:6px;">\u2713 Automatisch erkannt: ${[didUrl?"URL ("+autoUrl+")":"",didCompany?"Unternehmen ("+autoCompany+")":""].filter(Boolean).join(", ")}</div>`
      : "";

    box.innerHTML = autoHint+
      '<div style="color:#ffd166;font-weight:700;margin-bottom:6px;">Alle Felder ‚Äî Klick auf ID zum Kopieren:</div>'+
      rows.map(([id,f])=>{
        const isAuto = id===autoUrl||id===autoCompany;
        return `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #1a1a26;${isAuto?"background:rgba(34,197,94,0.05);":""}">`+
          `<span style="color:${isAuto?"#22c55e":"#f0f0f5"};">${esc(f.name||id)}</span>`+
          `<code style="color:#ffd166;cursor:pointer;" onclick="navigator.clipboard.writeText('${id}')" title="Kopieren">${id}</code>`+
          `</div>`;
      }).join('');
  } catch(ex){
    box.innerHTML='<span style="color:#ff4d6d">\u274C Nicht erreichbar.</span>';
  }
}

async function testJiraConnection(){
  const domain   = document.getElementById("jDomain").value.trim().replace(/^https?:\/\//,"").replace(/\/+$/,"");
  const email    = document.getElementById("jEmail").value.trim();
  const token    = document.getElementById("jToken").value.trim();
  const useProxy = document.getElementById("jUseProxy").checked;
  const st       = document.getElementById("jiraModalStatus");
  const btn      = document.getElementById("jTestBtn");

  if(!domain||!email||!token){
    st.innerHTML = '<span style="color:#ff4d6d">\u26A0\uFE0F Bitte Domain, E-Mail und Token eingeben.</span>';
    return;
  }

  st.innerHTML = '<span style="color:#6b6b80">\u23F3 Teste Verbindung\u2026</span>';
  btn.disabled = true;

  const auth = btoa(email+":"+token);
  const hdrs = { "Authorization":"Basic "+auth, "Accept":"application/json" };
  let testUrl;
  if(useProxy){ testUrl="/jira/test"; hdrs["X-Jira-Domain"]=domain; }
  else         { testUrl="https://"+domain+"/rest/api/3/myself"; }

  try {
    const resp = await fetch(testUrl, { headers:hdrs });
    const data = await resp.json().catch(()=>({}));
    if(resp.ok){
      const name = data.displayName || data.emailAddress || "OK";
      st.innerHTML = '<span style="color:#22c55e">\u2713 Verbunden als: <b>'+esc(name)+'</b></span>';
    } else if(resp.status===401){
      st.innerHTML = '<span style="color:#ff4d6d">\u274C Zugangsdaten ung√ºltig (401) ‚Äî E-Mail oder API Token pr√ºfen.</span>';
    } else {
      const msg = (data.errorMessages&&data.errorMessages[0]) || data.message || ("HTTP "+resp.status);
      st.innerHTML = '<span style="color:#ff4d6d">\u274C '+esc(msg)+'</span>';
    }
  } catch(ex){
    const hint = useProxy ? " L√§uft der Docker-Container / server.py?" : "";
    st.innerHTML = '<span style="color:#ff4d6d">\u274C Nicht erreichbar.'+esc(hint)+'</span>';
  }
  btn.disabled = false;
}

// ‚îÄ‚îÄ Auth functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function checkAuth(){
  // Passwort-Reset-Token aus der URL lesen
  const params = new URLSearchParams(window.location.search);
  const resetToken = params.get("reset");
  if(resetToken){
    _resetToken = resetToken;
    _authMode   = "reset";
    _updateAuthModal();
    document.getElementById("authPw").value  = "";
    document.getElementById("authPw2").value = "";
    document.getElementById("authStatus").innerHTML = "";
    document.getElementById("authModal").style.display = "flex";
    setTimeout(()=>document.getElementById("authPw").focus(), 50);
    return; // Kein Session-Check n√∂tig beim Reset
  }

  try {
    const r = await fetch("/auth/me", { credentials:"include" });
    const d = await r.json();
    if(d.user){
      AUTH.user = d.user;
      await loadUserData();
    }
  } catch(e) { /* Server nicht erreichbar ‚Äì App funktioniert trotzdem */ }
  updateUserBar();
  refreshBadge();
  updateJiraCfgBtn();
}

function updateUserBar(){
  const bar      = document.getElementById("userBar");
  const btn      = document.getElementById("loginBtn");
  const nm       = document.getElementById("uname");
  const adminBtn = document.getElementById("adminBtn");
  if(AUTH.user){
    nm.textContent = "üë§ "+AUTH.user.username;
    bar.style.display = "flex";
    btn.style.display = "none";
    adminBtn.style.display = AUTH.user.is_admin ? "" : "none";
  } else {
    bar.style.display = "none";
    btn.style.display = "";
    adminBtn.style.display = "none";
  }
}

// ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAdminPanel(){
  document.getElementById("adminModal").style.display = "flex";
  loadAdminUsers();
}

function closeAdminPanel(){
  document.getElementById("adminModal").style.display = "none";
}

async function loadAdminUsers(){
  const tbody = document.getElementById("adminTbody");
  const status = document.getElementById("adminStatus");
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:#6b6b80;">Wird geladen‚Ä¶</td></tr>';
  status.innerHTML = "";
  try {
    const r = await fetch("/admin/users", { credentials:"include" });
    if(!r.ok){ status.innerHTML = `<span class="errbx">Fehler: ${(await r.json()).error}</span>`; return; }
    const users = await r.json();
    if(!users.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:#6b6b80;">Keine Benutzer vorhanden.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const isSelf = u.id === AUTH.user.id;
      const date   = u.created_at ? u.created_at.slice(0,10) : "‚Äì";
      const statusBadge = u.is_locked
        ? '<span class="admin-badge locked">Gesperrt</span>'
        : '<span class="admin-badge active">Aktiv</span>';
      const adminBadge = u.is_admin
        ? '<span class="admin-badge admin">Admin</span>'
        : '<span style="color:#6b6b80;font-size:11px;">‚Äì</span>';
      const lockLabel  = u.is_locked ? "Entsperren" : "Sperren";
      const lockClass  = u.is_locked ? "admin-action ok" : "admin-action";
      return `<tr data-uid="${u.id}">
        <td style="font-weight:600">${_esc(u.username)}${isSelf ? ' <span style="color:#6b6b80;font-size:11px;">(du)</span>' : ''}</td>
        <td><input class="admin-ipt" data-field="email" value="${_esc(u.email||'')}" placeholder="‚Äì" onkeydown="if(event.key==='Enter')_adminSaveField(${u.id},this)"></td>
        <td style="color:#6b6b80">${date}</td>
        <td style="text-align:center">${adminBadge}</td>
        <td style="text-align:center">${statusBadge}</td>
        <td style="text-align:right;white-space:nowrap;display:flex;gap:6px;justify-content:flex-end;">
          <button class="admin-action ok" onclick="_adminSaveField(${u.id},this.closest('tr').querySelector('[data-field=email]'))">üíæ</button>
          ${!isSelf ? `<button class="${lockClass}" onclick="adminToggleLock(${u.id},${u.is_locked?0:1})">${lockLabel}</button>` : ''}
          ${!isSelf ? `<button class="admin-action" style="border-color:rgba(255,77,109,.3);color:#ff4d6d;" onclick="adminDeleteUser(${u.id},'${_esc(u.username)}')">L√∂schen</button>` : ''}
          ${!isSelf ? `<button class="admin-action" onclick="adminToggleAdmin(${u.id},${u.is_admin?0:1})">${u.is_admin ? 'Admin entziehen' : 'Zum Admin'}</button>` : ''}
        </td>
      </tr>`;
    }).join("");
  } catch(e){
    status.innerHTML = `<span class="errbx">Netzwerkfehler: ${e.message}</span>`;
  }
}

function _esc(s){ const d=document.createElement("div"); d.textContent=String(s||""); return d.innerHTML; }

async function _adminPatch(uid, payload){
  const r = await fetch(`/admin/users/${uid}`, {
    method:"PATCH", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  return r;
}

async function _adminSaveField(uid, input){
  const val = input.value.trim();
  const r = await _adminPatch(uid, { email: val });
  const status = document.getElementById("adminStatus");
  if(r.ok){
    status.innerHTML = '<span style="color:#22c55e">‚úì E-Mail gespeichert</span>';
    setTimeout(()=>status.innerHTML="", 2500);
  } else {
    const j = await r.json();
    status.innerHTML = `<span class="errbx">${j.error}</span>`;
  }
}

async function adminToggleLock(uid, newVal){
  const r = await _adminPatch(uid, { is_locked: newVal });
  if(r.ok){ loadAdminUsers(); }
  else { const j=await r.json(); document.getElementById("adminStatus").innerHTML=`<span class="errbx">${j.error}</span>`; }
}

async function adminToggleAdmin(uid, newVal){
  if(!confirm(newVal ? "Diesem Benutzer Adminrechte geben?" : "Adminrechte entziehen?")) return;
  const r = await _adminPatch(uid, { is_admin: newVal });
  if(r.ok){ loadAdminUsers(); }
  else { const j=await r.json(); document.getElementById("adminStatus").innerHTML=`<span class="errbx">${j.error}</span>`; }
}

async function adminDeleteUser(uid, username){
  if(!confirm(`Benutzer ‚Äû${username}" und alle zugeh√∂rigen Daten unwiderruflich l√∂schen?`)) return;
  const r = await fetch(`/admin/users/${uid}`, { method:"DELETE", credentials:"include" });
  if(r.ok){ loadAdminUsers(); }
  else { const j=await r.json(); document.getElementById("adminStatus").innerHTML=`<span class="errbx">${j.error}</span>`; }
}

async function loadUserData(){
  try {
    const r = await fetch("/user/data", { credentials:"include" });
    if(!r.ok) return;
    const d = await r.json();
    localStorage.setItem("jf2_saved", JSON.stringify(d.saved   || {}));
    localStorage.setItem("jf2_ign",   JSON.stringify(d.ignored || []));
    localStorage.setItem("jf2_jira",  JSON.stringify(d.jira    || {}));
  } catch(e) {}
}

async function syncUserData(){
  if(!AUTH.user) return;
  try {
    await fetch("/user/data", {
      method:"POST", credentials:"include",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ saved:LS.saved(), ignored:LS.ignored(), jira:JIRA.get() })
    });
  } catch(e) {}
}

function requireAuth(hint, action){
  if(AUTH.user){ action(); return; }
  _pendingAction = action;
  openAuthModal(hint);
}

function openAuthModal(hint){
  _authMode = "login";
  _updateAuthModal();
  const h = document.getElementById("authHint");
  if(hint){ h.textContent = hint; h.style.display = "block"; }
  else { h.style.display = "none"; }
  document.getElementById("authStatus").innerHTML = "";
  document.getElementById("authUser").value  = "";
  document.getElementById("authEmail").value = "";
  document.getElementById("authPw").value    = "";
  document.getElementById("authPw2").value   = "";
  document.getElementById("authModal").style.display = "flex";
  setTimeout(()=>document.getElementById("authUser").focus(), 50);
}

function closeAuthModal(){
  document.getElementById("authModal").style.display = "none";
  _pendingAction = null;
}

function _updateAuthModal(){
  const m = _authMode;
  const show = (id, v) => document.getElementById(id).style.display = v ? "" : "none";
  const titles = {
    login:    "üîê Anmelden",
    register: "üÜï Registrieren",
    forgot:   "üîë Passwort vergessen",
    reset:    "üîí Neues Passwort"
  };
  const subs = {
    login:    "Melde dich an, um Stellen zu speichern und Jira zu nutzen.",
    register: "Erstelle dein Konto f√ºr JobPipeline.",
    forgot:   "Gib deine E-Mail ein ‚Äì du erh√§ltst einen Reset-Link.",
    reset:    "Vergib ein neues Passwort f√ºr dein Konto."
  };
  const btnTxt = { login:"Anmelden", register:"Registrieren", forgot:"Link senden", reset:"Passwort speichern" };
  const toggleTxt = {
    login:    "Noch kein Konto? ‚Üí Registrieren",
    register: "Bereits ein Konto? ‚Üí Anmelden",
    forgot:   "‚Üê Zur√ºck zur Anmeldung",
    reset:    ""
  };
  document.getElementById("authTitle").textContent     = titles[m];
  document.getElementById("authSub").textContent       = subs[m];
  document.getElementById("authSubmitBtn").textContent = btnTxt[m];
  document.getElementById("authToggle").textContent    = toggleTxt[m];
  show("authToggle",    m !== "reset");
  show("authUserWrap",  m === "login" || m === "register");
  show("authEmailWrap", m === "register" || m === "forgot");
  show("authPwWrap",    m === "login" || m === "register" || m === "reset");
  show("authPw2Wrap",   m === "register" || m === "reset");
  show("authForgotLink",m === "login");
  document.getElementById("authEmailLabel").textContent =
    m === "register" ? "‚úâÔ∏è E-Mail (f√ºr Passwort-Reset)" : "‚úâÔ∏è E-Mail-Adresse";
  document.getElementById("authPwLabel").textContent =
    m === "reset" ? "üîë Neues Passwort" : "üîë Passwort";
}

function toggleAuthMode(){
  _authMode = (_authMode === "login") ? "register" : "login";
  _updateAuthModal();
  document.getElementById("authStatus").innerHTML = "";
}

function switchToForgot(){
  _authMode = "forgot";
  _updateAuthModal();
  document.getElementById("authStatus").innerHTML = "";
  document.getElementById("authEmail").value = "";
  setTimeout(()=>document.getElementById("authEmail").focus(), 50);
}

async function doAuth(){
  if(_authMode === "forgot") { await doForgot(); return; }
  if(_authMode === "reset")  { await doReset();  return; }

  const username = document.getElementById("authUser").value.trim();
  const password = document.getElementById("authPw").value;
  const st  = document.getElementById("authStatus");
  const btn = document.getElementById("authSubmitBtn");
  if(!username || !password){
    st.innerHTML = '<span style="color:#ff4d6d">Bitte alle Felder ausf√ºllen.</span>'; return;
  }
  btn.disabled = true;

  if(_authMode === "register"){
    const pw2   = document.getElementById("authPw2").value;
    const email = document.getElementById("authEmail").value.trim();
    if(password !== pw2){
      st.innerHTML = '<span style="color:#ff4d6d">Passw√∂rter stimmen nicht √ºberein.</span>';
      btn.disabled = false; return;
    }
    const r = await fetch("/auth/register", {
      method:"POST", credentials:"include",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({username, password, email: email||undefined})
    }).catch(()=>null);
    if(!r){ st.innerHTML='<span style="color:#ff4d6d">Verbindungsfehler.</span>'; btn.disabled=false; return; }
    const d = await r.json();
    if(!r.ok){ st.innerHTML='<span style="color:#ff4d6d">'+esc(d.error||"Fehler")+'</span>'; btn.disabled=false; return; }
    AUTH.user = { username: d.username, is_admin: d.is_admin || false };
  } else {
    const r = await fetch("/auth/login", {
      method:"POST", credentials:"include",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({username, password})
    }).catch(()=>null);
    if(!r){ st.innerHTML='<span style="color:#ff4d6d">Verbindungsfehler.</span>'; btn.disabled=false; return; }
    const d = await r.json();
    if(!r.ok){ st.innerHTML='<span style="color:#ff4d6d">'+esc(d.error||"Fehler")+'</span>'; btn.disabled=false; return; }
    AUTH.user = { username: d.username, is_admin: d.is_admin || false };
    await loadUserData();
  }
  updateUserBar();
  refreshBadge();
  updateJiraCfgBtn();
  closeAuthModal();
  if(_pendingAction){ const fn=_pendingAction; _pendingAction=null; fn(); }
}

async function doForgot(){
  const email = document.getElementById("authEmail").value.trim();
  const st  = document.getElementById("authStatus");
  const btn = document.getElementById("authSubmitBtn");
  if(!email){ st.innerHTML='<span style="color:#ff4d6d">Bitte E-Mail eingeben.</span>'; return; }
  btn.disabled = true;
  const r = await fetch("/auth/forgot", {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({email})
  }).catch(()=>null);
  btn.disabled = false;
  if(!r){ st.innerHTML='<span style="color:#ff4d6d">Verbindungsfehler.</span>'; return; }
  const d = await r.json();
  if(!r.ok){ st.innerHTML='<span style="color:#ff4d6d">'+esc(d.error||"Fehler")+'</span>'; return; }
  st.innerHTML = '<span style="color:#22c55e">‚úì Falls ein Konto existiert, wurde ein Reset-Link gesendet.</span>';
  btn.disabled = true;
}

async function doReset(){
  const password = document.getElementById("authPw").value;
  const pw2      = document.getElementById("authPw2").value;
  const st  = document.getElementById("authStatus");
  const btn = document.getElementById("authSubmitBtn");
  if(!password){ st.innerHTML='<span style="color:#ff4d6d">Bitte Passwort eingeben.</span>'; return; }
  if(password !== pw2){ st.innerHTML='<span style="color:#ff4d6d">Passw√∂rter stimmen nicht √ºberein.</span>'; return; }
  btn.disabled = true;
  const r = await fetch("/auth/reset", {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({token: _resetToken, password})
  }).catch(()=>null);
  if(!r){ st.innerHTML='<span style="color:#ff4d6d">Verbindungsfehler.</span>'; btn.disabled=false; return; }
  const d = await r.json();
  if(!r.ok){ st.innerHTML='<span style="color:#ff4d6d">'+esc(d.error||"Fehler")+'</span>'; btn.disabled=false; return; }
  st.innerHTML = '<span style="color:#22c55e">‚úì Passwort gespeichert. Du kannst dich jetzt anmelden.</span>';
  _resetToken = null;
  history.replaceState({}, document.title, window.location.pathname);
  setTimeout(()=>{ _authMode="login"; _updateAuthModal(); document.getElementById("authStatus").innerHTML=""; }, 2500);
}

async function doLogout(){
  await fetch("/auth/logout", { method:"POST", credentials:"include" }).catch(()=>{});
  AUTH.user = null;
  updateUserBar();
  localStorage.removeItem("jf2_saved");
  localStorage.removeItem("jf2_ign");
  localStorage.removeItem("jf2_jira");
  refreshBadge();
  updateJiraCfgBtn();
  if(document.getElementById("tabSaved").style.display !== "none") renderSaved();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
checkAuth();
</script>
</body>
</html>
